<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plant Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;600&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root { --dark: #1a1a2e; --glass: rgba(255, 255, 255, 0.05); --green: #00d2ff; --text: #e0e0e0; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { background-color: var(--dark); color: var(--text); padding-bottom: 80px; }

        /* HEADER */
        .header { display: flex; justify-content: space-between; align-items: center; padding: 20px; background: var(--glass); backdrop-filter: blur(10px); position: sticky; top: 0; z-index: 100; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .menu-btn { font-size: 1.5rem; cursor: pointer; color: var(--green); }
        
        /* GRAPH SECTION */
        .chart-container { width: 90%; margin: 20px auto; background: var(--glass); padding: 20px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); height: 250px; display: flex; justify-content: center; position: relative; }
        .chart-title { position: absolute; top: 10px; left: 20px; font-size: 0.9rem; color: #aaa; }

        /* DATE NAVIGATOR */
        .date-nav { display: flex; justify-content: space-between; align-items: center; width: 90%; margin: 20px auto; background: var(--glass); padding: 10px 20px; border-radius: 50px; border: 1px solid rgba(255,255,255,0.1); }
        .nav-btn { background: none; border: none; color: var(--green); font-size: 1.2rem; cursor: pointer; }
        .current-date { font-weight: 600; }

        /* EXPENSE LIST */
        .expense-list { width: 90%; margin: 0 auto; }
        .expense-item { display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.03); padding: 15px; margin-bottom: 10px; border-radius: 12px; border-left: 4px solid var(--green); }
        .item-left h4 { font-size: 1rem; margin-bottom: 2px; }
        .item-left p { font-size: 0.75rem; color: #aaa; }
        .item-right { text-align: right; }
        .amount { font-size: 1.1rem; font-weight: bold; color: var(--green); }
        .badge { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; background: rgba(255,255,255,0.1); margin-left: 5px; }

        /* FAB (PLUS BUTTON) */
        .fab { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; background: var(--green); border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 2rem; color: #000; box-shadow: 0 5px 15px rgba(0,210,255,0.4); cursor: pointer; transition: 0.3s; z-index: 100; border: none; }
        .fab:hover { transform: scale(1.1); }

        /* SIDEBAR */
        .sidebar { position: fixed; top: 0; right: -300px; width: 280px; height: 100%; background: #16213e; z-index: 200; transition: 0.4s; padding: 20px; box-shadow: -5px 0 15px rgba(0,0,0,0.5); overflow-y: auto; }
        .sidebar.active { right: 0; }
        .close-btn { font-size: 1.5rem; color: #ff6b6b; cursor: pointer; float: right; }
        .sidebar h3 { margin-top: 40px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; color: var(--green); }
        .menu-item { margin: 15px 0; font-size: 0.9rem; }
        .admin-section { display: none; } /* Hidden by default */

        /* MODAL (ADD FORM) */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 300; justify-content: center; align-items: center; }
        .modal-content { background: #222; padding: 25px; border-radius: 15px; width: 90%; max-width: 400px; position: relative; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-size: 0.9rem; color: #aaa; }
        .form-group input, .form-group select { width: 100%; padding: 10px; background: #333; border: 1px solid #444; color: white; border-radius: 5px; }
        .btn-submit { width: 100%; padding: 12px; background: var(--green); border: none; border-radius: 5px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .close-modal { position: absolute; top: 15px; right: 15px; font-size: 1.2rem; cursor: pointer; color: #ff6b6b; }

    </style>
</head>
<body>

<div class="header">
    <div style="font-weight: bold; font-size: 1.2rem;">üå± My Plant Biz</div>
    <div class="menu-btn" onclick="toggleSidebar()"><i class="fas fa-bars"></i></div>
</div>

<div class="chart-container">
    <div class="chart-title">This Month's Spending</div>
    <canvas id="expenseChart"></canvas>
</div>

<div class="date-nav">
    <button class="nav-btn" onclick="changeDate(-1)"><i class="fas fa-chevron-left"></i></button>
    <div class="current-date" id="displayDate">Today</div>
    <button class="nav-btn" onclick="changeDate(1)"><i class="fas fa-chevron-right"></i></button>
</div>

<div class="expense-list" id="expenseContainer">
    <div style="text-align: center; color: #555; margin-top: 20px;">Loading...</div>
</div>

<button class="fab" onclick="openModal()"><i class="fas fa-plus"></i></button>

<div class="sidebar" id="sidebar">
    <div class="close-btn" onclick="toggleSidebar()"><i class="fas fa-times"></i></div>
    
    <h3>üí∞ Total Fund</h3>
    <div id="fundList" style="margin-top: 10px; font-size: 0.85rem; color: #ccc;">
        </div>

    <div class="admin-section" id="adminControls">
        <h3>üîë Admin Controls</h3>
        
        <div style="margin-top: 15px;">
            <p style="color: #aaa; margin-bottom: 5px;">Add Partner ID</p>
            <input type="text" id="newInfoName" placeholder="Name" style="width: 100%; padding: 5px; margin-bottom: 5px; background: #333; border: none; color: white;">
            <input type="text" id="newInfoUser" placeholder="Username" style="width: 100%; padding: 5px; margin-bottom: 5px; background: #333; border: none; color: white;">
            <input type="text" id="newInfoPass" placeholder="Password" style="width: 100%; padding: 5px; margin-bottom: 5px; background: #333; border: none; color: white;">
            <button onclick="createUser()" style="width: 100%; padding: 5px; background: #ffcc00; border: none; cursor: pointer;">Create User</button>
        </div>

        <div style="margin-top: 15px;">
            <p style="color: #aaa; margin-bottom: 5px;">Add Fund Record</p>
            <input type="text" id="fundName" placeholder="Partner Name" style="width: 100%; padding: 5px; margin-bottom: 5px; background: #333; border: none; color: white;">
            <input type="number" id="fundAmount" placeholder="Amount" style="width: 100%; padding: 5px; margin-bottom: 5px; background: #333; border: none; color: white;">
            <input type="date" id="fundDate" style="width: 100%; padding: 5px; margin-bottom: 5px; background: #333; border: none; color: white;">
            <button onclick="addFund()" style="width: 100%; padding: 5px; background: #00d2ff; border: none; cursor: pointer;">Save Fund</button>
        </div>

        <h3>üïí Login History</h3>
        <div id="loginLogs" style="font-size: 0.8rem; color: #888; max-height: 150px; overflow-y: auto;"></div>
    </div>

    <button onclick="logout()" style="width: 100%; padding: 10px; background: #ff4b2b; color: white; border: none; margin-top: 30px; border-radius: 5px;">Logout</button>
</div>

<div class="modal" id="entryModal">
    <div class="modal-content">
        <div class="close-modal" onclick="closeModal()"><i class="fas fa-times"></i></div>
        <h3 style="color: var(--green); margin-bottom: 20px;">Add New Expense</h3>
        <form id="expenseForm">
            <div class="form-group">
                <label>Item Name</label>
                <input type="text" id="itemName" placeholder="e.g. Tape, Pot" required>
            </div>
            <div class="form-group">
                <label>Category</label>
                <select id="category">
                    <option value="Plant">üåø Plant Related</option>
                    <option value="Other">üõ†Ô∏è Other / Food</option>
                </select>
            </div>
            <div class="form-group">
                <label>Amount (Tk)</label>
                <input type="number" id="amount" placeholder="50" required>
            </div>
            <button type="submit" class="btn-submit">Submit</button>
        </form>
    </div>
</div>

<script>
    let currentDate = new Date(); // Tracks selected date
    let myChart = null;

    // --- INIT ---
    async function init() {
        const res = await fetch('/api/session');
        const user = await res.json();
        
        if (!user.loggedIn) {
            window.location.href = 'login.html';
            return;
        }

        // Show Admin Controls if admin
        if (user.role === 'admin') {
            document.getElementById('adminControls').style.display = 'block';
            loadLogs();
        }

        updateDateDisplay();
        loadExpenses();
        loadChart();
        loadFunds();
    }

    // --- DATE LOGIC ---
    function updateDateDisplay() {
        const options = { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' };
        document.getElementById('displayDate').innerText = currentDate.toLocaleDateString('en-US', options);
    }

    function changeDate(days) {
        currentDate.setDate(currentDate.getDate() + days);
        updateDateDisplay();
        loadExpenses(); // Reload data for new date
    }

    // --- DATA LOADING ---
    async function loadExpenses() {
        // Format date as YYYY-MM-DD for API
        const year = currentDate.getFullYear();
        const month = String(currentDate.getMonth() + 1).padStart(2, '0');
        const day = String(currentDate.getDate()).padStart(2, '0');
        const formattedDate = `${year}-${month}-${day}`;

        const res = await fetch(`/api/expense?date=${formattedDate}`);
        const data = await res.json();
        
        const container = document.getElementById('expenseContainer');
        if(data.length === 0) {
            container.innerHTML = '<div style="text-align:center; color:#555; margin-top:20px;">No expenses for this date.</div>';
            return;
        }

        container.innerHTML = data.map(item => `
            <div class="expense-item">
                <div class="item-left">
                    <h4>${item.itemName} <span class="badge" style="color:${item.category==='Plant'?'#00d2ff':'orange'}">${item.category}</span></h4>
                    <p>Added by: ${item.addedBy} at ${item.time}</p>
                </div>
                <div class="item-right">
                    <div class="amount">${item.amount} ‡ß≥</div>
                </div>
            </div>
        `).join('');
    }

    async function loadFunds() {
        const res = await fetch('/api/fund');
        const data = await res.json();
        document.getElementById('fundList').innerHTML = data.map(f => `
            <div style="border-bottom: 1px solid rgba(255,255,255,0.05); padding: 8px 0;">
                <div style="display:flex; justify-content:space-between;">
                    <span style="color:white; font-weight:bold;">${f.name}</span>
                    <span style="color:#00d2ff;">${f.amount} ‡ß≥</span>
                </div>
                <div style="font-size:0.7rem;">Date: ${f.date}</div>
            </div>
        `).join('');
    }

    async function loadLogs() {
        const res = await fetch('/api/logs');
        const logs = await res.json();
        document.getElementById('loginLogs').innerHTML = logs.map(l => `
            <div style="margin-bottom:5px;">${l.name} - ${l.date} ${l.loginTime}</div>
        `).join('');
    }

    // --- CHART LOGIC ---
    async function loadChart() {
        const res = await fetch('/api/summary');
        const data = await res.json();

        const ctx = document.getElementById('expenseChart').getContext('2d');
        if(myChart) myChart.destroy(); // Clear old chart

        myChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Plants', 'Others'],
                datasets: [{
                    data: [data.plant, data.other],
                    backgroundColor: ['#00d2ff', '#ffaa00'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'right', labels: { color: 'white' } }
                }
            }
        });
    }

    // --- ACTIONS ---
    document.getElementById('expenseForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        // Format Date YYYY-MM-DD
        const year = currentDate.getFullYear();
        const month = String(currentDate.getMonth() + 1).padStart(2, '0');
        const day = String(currentDate.getDate()).padStart(2, '0');
        const formattedDate = `${year}-${month}-${day}`;
        
        const data = {
            date: formattedDate,
            time: new Date().toLocaleTimeString(),
            itemName: document.getElementById('itemName').value,
            category: document.getElementById('category').value,
            amount: document.getElementById('amount').value
        };

        await fetch('/api/expense', {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        
        closeModal();
        loadExpenses();
        loadChart(); // Update chart
        alert('Saved!');
    });

    // Admin Functions
    async function createUser() {
        const name = document.getElementById('newInfoName').value;
        const username = document.getElementById('newInfoUser').value;
        const password = document.getElementById('newInfoPass').value;
        await fetch('/api/create-user', {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({name, username, password})
        });
        alert('User Created!');
    }

    async function addFund() {
        const name = document.getElementById('fundName').value;
        const amount = document.getElementById('fundAmount').value;
        const date = document.getElementById('fundDate').value;
        await fetch('/api/fund', {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({name, amount, date})
        });
        alert('Fund Added!');
        loadFunds();
    }

    async function logout() {
        await fetch('/api/logout');
        window.location.href = 'login.html';
    }

    // UI Toggles
    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('active'); }
    function openModal() { document.getElementById('entryModal').style.display = 'flex'; }
    function closeModal() { document.getElementById('entryModal').style.display = 'none'; }

    init();
</script>
</body>
</html>