<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plant Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;600&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root { --dark: #1a1a2e; --glass: rgba(255, 255, 255, 0.05); --green: #00d2ff; --pink: #e94560; --text: #e0e0e0; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { background-color: var(--dark); color: var(--text); padding-bottom: 80px; }

        .header { display: flex; justify-content: space-between; align-items: center; padding: 20px; background: var(--glass); backdrop-filter: blur(10px); position: sticky; top: 0; z-index: 100; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .menu-btn { font-size: 1.5rem; cursor: pointer; color: var(--green); }

        /* Dual Chart Container */
        .charts-row { display: flex; gap: 10px; width: 90%; margin: 20px auto; }
        .chart-box { flex: 1; background: var(--glass); padding: 15px; border-radius: 15px; border: 1px solid rgba(255,255,255,0.1); height: 220px; position: relative; }
        .chart-title { position: absolute; top: 10px; left: 15px; font-size: 0.8rem; color: #aaa; font-weight: bold; }

        .date-section { width: 90%; margin: 10px auto; text-align: center; }
        .date-nav { display: flex; justify-content: space-between; align-items: center; background: var(--glass); padding: 10px 20px; border-radius: 50px; border: 1px solid rgba(255,255,255,0.1); margin-bottom: 10px; }
        .nav-btn { background: none; border: none; color: var(--green); font-size: 1.2rem; cursor: pointer; }
        .current-date { font-weight: 600; }
        .daily-total-badge { background: #ffaa00; color: black; padding: 5px 15px; border-radius: 20px; font-weight: bold; font-size: 0.9rem; display: inline-block; }

        .expense-list { width: 90%; margin: 0 auto; }
        .expense-item { display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.03); padding: 15px; margin-bottom: 10px; border-radius: 12px; border-left: 4px solid var(--green); }
        .amount { font-size: 1.1rem; font-weight: bold; color: var(--green); }
        
        .action-btn { background: none; border: none; cursor: pointer; margin-left: 8px; font-size: 0.9rem; }
        .btn-edit { color: #ffcc00; }
        .btn-del { color: #ff4b2b; }

        .fab { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; background: var(--green); border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 2rem; color: #000; box-shadow: 0 5px 15px rgba(0,210,255,0.4); cursor: pointer; z-index: 100; border: none; }

        .sidebar { position: fixed; top: 0; right: -340px; width: 320px; height: 100%; background: #111; z-index: 200; transition: 0.4s; padding: 20px; box-shadow: -5px 0 15px rgba(0,0,0,0.5); overflow-y: auto; }
        .sidebar.active { right: 0; }
        .close-btn { font-size: 1.5rem; color: #ff6b6b; cursor: pointer; float: right; }
        
        .finance-card { background: rgba(255,255,255,0.05); border-radius: 10px; padding: 15px; margin-top: 40px; border: 1px solid rgba(255,255,255,0.1); }
        .fund-item { background: #222; padding: 8px; margin-bottom: 5px; border-radius: 5px; font-size: 0.8rem; display: flex; justify-content: space-between; align-items: center; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 300; justify-content: center; align-items: center; }
        .modal-content { background: #222; padding: 25px; border-radius: 15px; width: 90%; max-width: 400px; position: relative; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-size: 0.9rem; color: #aaa; }
        .form-group input, .form-group select { width: 100%; padding: 10px; background: #333; border: 1px solid #444; color: white; border-radius: 5px; }
        .btn-submit { width: 100%; padding: 12px; background: var(--green); border: none; border-radius: 5px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .close-modal { position: absolute; top: 15px; right: 15px; font-size: 1.2rem; cursor: pointer; color: #ff6b6b; }
        .badge { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; background: rgba(255,255,255,0.1); margin-left: 5px; }
    </style>
</head>
<body>

<div class="header">
    <div style="font-weight: bold; font-size: 1.2rem;">üå± My Plant Biz</div>
    <div class="menu-btn" onclick="toggleSidebar()"><i class="fas fa-bars"></i></div>
</div>

<div class="charts-row">
    <div class="chart-box">
        <div class="chart-title">Month (Selected)</div>
        <canvas id="monthChart"></canvas>
    </div>
    <div class="chart-box">
        <div class="chart-title">Today's Bar</div>
        <canvas id="dayChart"></canvas>
    </div>
</div>

<div class="date-section">
    <div class="daily-total-badge" id="dailyTotal">Total: ‚Çπ 0.00</div>
    <div class="date-nav">
        <button class="nav-btn" onclick="changeDate(-1)"><i class="fas fa-chevron-left"></i></button>
        <div class="current-date" id="displayDate">Today</div>
        <button class="nav-btn" onclick="changeDate(1)"><i class="fas fa-chevron-right"></i></button>
    </div>
</div>

<div class="expense-list" id="expenseContainer">Loading...</div>
<button class="fab" onclick="openExpenseModal()"><i class="fas fa-plus"></i></button>

<div class="sidebar" id="sidebar">
    <div class="close-btn" onclick="toggleSidebar()"><i class="fas fa-times"></i></div>

    <div class="finance-card">
        <h3 style="color:white; border-bottom:1px solid #444; padding-bottom:10px; margin-bottom:15px;">üí∞ Fund Hub</h3>
        <div style="display:flex; justify-content:space-between; margin-bottom:5px;"><span>Collected:</span> <span style="color:#00d2ff;" id="finCollected">‚Çπ 0</span></div>
        <div style="display:flex; justify-content:space-between; margin-bottom:5px;"><span>Expense:</span> <span style="color:#ff6b6b;" id="finExpense">‚Çπ 0</span></div>
        <div style="display:flex; justify-content:space-between; font-weight:bold; font-size:1.1rem; border-top:1px solid #333; padding-top:5px;"><span>Balance:</span> <span style="color:#ffcc00;" id="finBalance">‚Çπ 0</span></div>

        <h4 style="margin-top:20px; color:#aaa; font-size:0.8rem;">History & Control</h4>
        <div id="fundHistoryList" style="max-height: 200px; overflow-y: auto;"></div>

        <h4 style="margin-top:15px; color:#aaa; font-size:0.8rem;">Cash In Hand</h4>
        <div id="holdingList"></div>
    </div>

    <div id="adminControls" style="display:none; margin-top:20px;">
        <div style="background:#222; padding:10px; border-radius:5px; margin-bottom:15px;">
            <p style="font-size:0.8rem; color:#00d2ff;">Update Cash In Hand</p>
            <input type="text" id="holdName" placeholder="Name" style="width:100%; padding:5px; background:#333; border:none; color:white;">
            <select id="holdType" style="width:100%; margin-top:2px; padding:5px; background:#333; border:none; color:white;"><option value="Cash">Cash</option><option value="Online">Online</option></select>
            <input type="number" id="holdAmount" placeholder="Amount" style="width:100%; margin-top:2px; padding:5px; background:#333; border:none; color:white;">
            <button onclick="updateHolding()" style="width:100%; padding:5px; background:#00d2ff; border:none; margin-top:5px;">Update</button>
        </div>
        <button onclick="openFundModal()" style="width:100%; padding:5px; background:#444; color:white; border:none; margin-bottom:5px;">+ Add Fund</button>
        <button onclick="document.getElementById('userCreate').style.display='block'" style="width:100%; padding:5px; background:#444; color:white; border:none;">+ Create User</button>
        <div id="userCreate" style="display:none; margin-top:5px;">
            <input type="text" id="uName" placeholder="Name" style="width:100%; padding:2px; background:#333; border:none; color:white;">
            <input type="text" id="uUser" placeholder="User" style="width:100%; padding:2px; background:#333; border:none; color:white;">
            <input type="text" id="uPass" placeholder="Pass" style="width:100%; padding:2px; background:#333; border:none; color:white;">
            <button onclick="createUser()" style="width:100%; background:#ffcc00; border:none;">Save</button>
        </div>
    </div>
    <button onclick="logout()" style="width: 100%; padding: 10px; background: #ff4b2b; color: white; border: none; margin-top: 30px; border-radius: 5px;">Logout</button>
</div>

<div class="modal" id="expenseModal">
    <div class="modal-content">
        <div class="close-modal" onclick="closeExpenseModal()"><i class="fas fa-times"></i></div>
        <h3 id="expModalTitle" style="color: var(--green); margin-bottom: 20px;">Expense</h3>
        <form id="expenseForm">
            <input type="hidden" id="expId">
            <div class="form-group"><label>Item</label><input type="text" id="itemName" required></div>
            <div class="form-group"><label>Category</label><select id="category"><option value="Plant">üåø Plant</option><option value="Other">üõ†Ô∏è Other</option></select></div>
            <div class="form-group"><label>Amount (‚Çπ)</label><input type="number" step="0.01" id="amount" required></div>
            <button type="submit" class="btn-submit">Save</button>
        </form>
    </div>
</div>

<div class="modal" id="fundModal">
    <div class="modal-content">
        <div class="close-modal" onclick="closeFundModal()"><i class="fas fa-times"></i></div>
        <h3 id="fundModalTitle" style="color: #ffcc00; margin-bottom: 20px;">Fund Entry</h3>
        <form id="fundForm">
            <input type="hidden" id="fundId">
            <div class="form-group"><label>Name</label><input type="text" id="fundNameInput" required></div>
            <div class="form-group"><label>Amount</label><input type="number" step="0.01" id="fundAmountInput" required></div>
            <div class="form-group"><label>Date</label><input type="date" id="fundDateInput" required></div>
            <button type="submit" class="btn-submit" style="background:#ffcc00; color:black;">Save Fund</button>
        </form>
    </div>
</div>

<script>
    let currentDate = new Date();
    let monthChart = null;
    let dayChart = null;
    let currentUserRole = '';
    const moneyFormat = new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', minimumFractionDigits: 2 });

    async function init() {
        const res = await fetch('/api/session');
        const user = await res.json();
        if (!user.loggedIn) { window.location.href = 'login.html'; return; }
        currentUserRole = user.role;
        if (user.role === 'admin') document.getElementById('adminControls').style.display = 'block';
        updateDateDisplay(); loadExpenses(); loadCharts(); loadFinancialStatus();
    }

    function updateDateDisplay() {
        const options = { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' };
        document.getElementById('displayDate').innerText = currentDate.toLocaleDateString('en-US', options);
    }
    function changeDate(days) { currentDate.setDate(currentDate.getDate() + days); updateDateDisplay(); loadExpenses(); loadCharts(); }

    async function loadExpenses() {
        const year = currentDate.getFullYear();
        const month = String(currentDate.getMonth() + 1).padStart(2, '0');
        const day = String(currentDate.getDate()).padStart(2, '0');
        const formattedDate = `${year}-${month}-${day}`;

        const res = await fetch(`/api/expense?date=${formattedDate}`);
        const data = await res.json();
        const container = document.getElementById('expenseContainer');
        let dailyTotal = 0;
        
        if(data.length === 0) container.innerHTML = '<div style="text-align:center; color:#555; margin-top:20px;">No expenses.</div>';
        else {
            container.innerHTML = data.map(item => {
                dailyTotal += parseFloat(item.amount);
                let actions = '';
                if(currentUserRole === 'admin') {
                    actions = `<button class="action-btn btn-edit" onclick="editExpense('${item.id}', '${item.itemName}', '${item.category}', '${item.amount}')"><i class="fas fa-pen"></i></button>
                               <button class="action-btn btn-del" onclick="deleteExpense('${item.id}')"><i class="fas fa-trash"></i></button>`;
                }
                return `<div class="expense-item">
                    <div class="item-left"><h4>${item.itemName} <span class="badge" style="color:${item.category==='Plant'?'#00d2ff':'orange'}">${item.category}</span></h4><p>By: ${item.addedBy} @ ${item.time}</p></div>
                    <div class="item-right"><div class="amount">${moneyFormat.format(item.amount)}</div>${actions}</div>
                </div>`;
            }).join('');
        }
        document.getElementById('dailyTotal').innerText = `Total: ${moneyFormat.format(dailyTotal)}`;
    }

    async function loadFinancialStatus() {
        const res = await fetch('/api/finance-status');
        const data = await res.json();
        document.getElementById('finCollected').innerText = moneyFormat.format(data.totalFund);
        document.getElementById('finExpense').innerText = moneyFormat.format(data.totalExpense);
        document.getElementById('finBalance').innerText = moneyFormat.format(data.balance);
        
        document.getElementById('fundHistoryList').innerHTML = data.fundList.map(f => {
            let actions = currentUserRole === 'admin' ? 
                `<button class="action-btn btn-edit" style="font-size:0.7rem;" onclick="editFund('${f.id}', '${f.name}', '${f.amount}', '${f.date}')"><i class="fas fa-pen"></i></button>
                 <button class="action-btn btn-del" style="font-size:0.7rem;" onclick="deleteFund('${f.id}')"><i class="fas fa-trash"></i></button>` : '';
            return `<div class="fund-item"><div><span>${f.name}</span><br><small style="color:#666;">${f.date}</small></div><div><span style="color:#00d2ff;">${moneyFormat.format(f.amount)}</span>${actions}</div></div>`;
        }).join('');

        document.getElementById('holdingList').innerHTML = data.holdings.map(h => 
            `<div style="display:flex; justify-content:space-between; font-size:0.8rem; background:#222; padding:5px; margin-bottom:2px;"><span>${h.name} (${h.type})</span><span style="color:#00d2ff;">${moneyFormat.format(h.amount)}</span></div>`
        ).join('');
    }

    async function loadCharts() {
        const year = currentDate.getFullYear();
        const month = String(currentDate.getMonth() + 1).padStart(2, '0');
        const day = String(currentDate.getDate()).padStart(2, '0');
        
        const res = await fetch(`/api/summary?date=${year}-${month}-${day}`);
        const data = await res.json();

        // Month Chart (Doughnut)
        const ctxM = document.getElementById('monthChart').getContext('2d');
        if(monthChart) monthChart.destroy();
        monthChart = new Chart(ctxM, {
            type: 'doughnut',
            data: { labels: ['Plant', 'Other'], datasets: [{ data: [data.month.plant, data.month.other], backgroundColor: ['#00d2ff', '#ffaa00'], borderWidth: 0 }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });

        // Day Chart (Bar)
        const ctxD = document.getElementById('dayChart').getContext('2d');
        if(dayChart) dayChart.destroy();
        dayChart = new Chart(ctxD, {
            type: 'bar',
            data: { labels: ['Plant', 'Other'], datasets: [{ label: 'Today', data: [data.day.plant, data.day.other], backgroundColor: ['#00d2ff', '#e94560'] }] },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.1)' } } }, plugins: { legend: { display: false } } }
        });
    }

    // --- ACTIONS ---
    async function deleteExpense(id) { if(confirm('Delete?')) { await fetch(`/api/expense/${id}`, { method: 'DELETE' }); loadExpenses(); loadCharts(); loadFinancialStatus(); } }
    async function deleteFund(id) { if(confirm('Delete Fund?')) { await fetch(`/api/fund/${id}`, { method: 'DELETE' }); loadFinancialStatus(); } }
    
    // Modal Openers
    function openExpenseModal() { document.getElementById('expenseModal').style.display = 'flex'; document.getElementById('expenseForm').reset(); document.getElementById('expId').value = ''; }
    window.editExpense = function(id, name, cat, amount) { openExpenseModal(); document.getElementById('expId').value = id; document.getElementById('itemName').value = name; document.getElementById('category').value = cat; document.getElementById('amount').value = amount; }
    function closeExpenseModal() { document.getElementById('expenseModal').style.display = 'none'; }
    
    function openFundModal() { document.getElementById('fundModal').style.display = 'flex'; document.getElementById('fundForm').reset(); document.getElementById('fundId').value = ''; }
    window.editFund = function(id, name, amount, date) { openFundModal(); document.getElementById('fundId').value = id; document.getElementById('fundNameInput').value = name; document.getElementById('fundAmountInput').value = amount; document.getElementById('fundDateInput').value = date; }
    function closeFundModal() { document.getElementById('fundModal').style.display = 'none'; }

    // Forms
    document.getElementById('expenseForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('expId').value;
        const data = { itemName: document.getElementById('itemName').value, category: document.getElementById('category').value, amount: document.getElementById('amount').value };
        if(id) await fetch('/api/expense-update', { method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({id, ...data}) });
        else {
             const d = currentDate.toISOString().split('T')[0];
             await fetch('/api/expense', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({date: d, time: new Date().toLocaleTimeString(), ...data}) });
        }
        closeExpenseModal(); loadExpenses(); loadCharts(); loadFinancialStatus();
    });

    document.getElementById('fundForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('fundId').value;
        const data = { name: document.getElementById('fundNameInput').value, amount: document.getElementById('fundAmountInput').value, date: document.getElementById('fundDateInput').value };
        if(id) await fetch('/api/fund-update', { method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({id, ...data}) });
        else await fetch('/api/fund', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) });
        closeFundModal(); loadFinancialStatus();
    });

    async function updateHolding() { await fetch('/api/update-holding', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ name: document.getElementById('holdName').value, type: document.getElementById('holdType').value, amount: document.getElementById('holdAmount').value }) }); alert('Updated'); loadFinancialStatus(); }
    async function createUser() { await fetch('/api/create-user', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ name: document.getElementById('uName').value, username: document.getElementById('uUser').value, password: document.getElementById('uPass').value }) }); alert('User Created'); }
    async function logout() { await fetch('/api/logout'); window.location.href = 'login.html'; }
    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('active'); }

    init();
</script>
</body>
</html>